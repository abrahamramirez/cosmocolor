#include <18F45K50.h>      
#device adc=10             
#fuses NOCPUDIV, HSH, PRIMARY, NOIESO, NOFCMEN
#use delay(internal=48MHz) 
#use RS232(baud=9600, parity=N, xmit=PIN_C6, rcv=PIN_C7, bits=8)
#include <stdlib.h>        
#include <lcd.c> 

#define TC_CLK  PIN_B0 
#define TC_CS   PIN_B1 
#define TC_DATA PIN_B2 

#include "max6675.c"
#include <math.h> 
#include "HMC5883.c" 

int16 adc = 0;
int32 val = 0;
int i = 0;
char msg[32]; 
float h = 0.0; 
int8 M_data[6]; //6 units 8 bit Measured datas
int16 Xm=0, Ym=0, Zm=0; //16 bit X,Y,Z variables

void main(){  
   lcd_init();       
   setup_adc_ports(sAN0);
   setup_adc(ADC_CLOCK_INTERNAL);               
   set_adc_channel(0); 
   hmc5883_init(); 
  
   while(1) { 
      M_data[0]=hmc5883_read(0x04); //Read X (LSB)
      M_data[1]=hmc5883_read(0x03); //Read X (MSB)
      M_data[2]=hmc5883_read(0x08); //Read Y (LSB)
      M_data[3]=hmc5883_read(0x07); //Read Y (MSB)
      M_data[4]=hmc5883_read(0x06); //Read Z (LSB)
      M_data[5]=hmc5883_read(0x05); //Read Z (MSB)
   
      Xm=make16(M_data[1],M_data[0]);
      Ym=make16(M_data[3],M_data[2]);
      Zm=make16(M_data[5],M_data[4]);
      
      float Heading = atan2((signed int16)Ym,(signed int16)Xm)* 180 / pi + 180;
       
      lcd_gotoxy(1,1);
      printf(lcd_putc,"X=%ld  ",Xm);
      lcd_gotoxy(9,1);
      printf(lcd_putc,"Y=%ld  ",Ym);
      lcd_gotoxy(1,2);
      printf(lcd_putc,"Z=%ld  ",Zm);
      lcd_gotoxy(9,2);
      printf(lcd_putc,"H=%f  ",Heading);
      delay_ms(100);
   
//!      for(i = 0; i < 30; i++){
//!         adc = read_adc(ADC_START_AND_READ);
//!         val += adc;
//!      }
//!      val /= 30;
//!      lcd_gotoxy(1,1);   
//!      printf(lcd_putc, "%Lu   ", val); 
//!      delay_ms(200);
      
//!      sprintf(msg,"%01.2f%cC\r\n",do_everything(),0xB0); 
//!      if(thermocouple_error) 
//!         printf("Thermocouple not connected\r\n");    
//!      else 
//!         printf("%s",msg); 
//!      lcd_gotoxy(1,2);   
//!      printf(lcd_putc, "%s", msg); 
   } 
}
